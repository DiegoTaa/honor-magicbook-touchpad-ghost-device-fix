# honor-magicbook-touchpad-ghost-device-fix

[English version of README](README_en.md) | [Auto_fix скрипт](auto_fix.sh)

Исправление самопроизвольной смены яркости экрана в Linux на ноутбуке Honor MagicBook. (Модель ноутбука: HONOR MagicBook X14 2025 5301ALWG/FRG-X)

## Что происходит

Touchpad-контроллер `GXTP7863` создаёт несколько `input`-устройств. Среди них есть фантомное устройство с именем `UNKNOWN` и обработчиком `kbd`, которое постоянно спамит кейкодами даже без прикосновения к тачпаду. Эти коды могут попадать в управление яркостью, вызывая её произвольные скачки.

Настоящий тачпад и фантомное устройство имеют одинаковые `Vendor`, `Product` и `Version`, но различаются по значению `properties`:

| Устройство | Name | Handlers | PROP |
|---|---|---|---|
| Настоящий тачпад | `...Touchpad` | `mouse` | `5` |
| Фантомное | `...UNKNOWN` | `kbd` | `0` |

## Как убедиться что проблема та же

Запустить:

```bash
cat /proc/bus/input/devices
```

Искать два устройства с одинаковыми `Vendor` и `Product` от контроллера `GXTP7863`. Одно будет называться `Touchpad` с `PROP=5`, второе - `UNKNOWN` с `PROP=0` и `Handlers=kbd`. Второе и нужно блокировать.

## Решение

Существует два способа исправить эту проблему: автоматическая установка через скрипт или ручная настройка.

### Способ 1: Автоматическая установка (рекомендуется)

Скачайте и запустите скрипт `auto_fix.sh`:

[Скачать скрипт](auto_fix.sh)

```bash
sudo ./auto_fix.sh
```

Скрипт автоматически:
1. Обнаружит фантомное устройство
2. Извлечёт правильные значения Bus/Vendor/Product/Version
3. Создаст udev-правило с этими значениями
4. Применит правило немедленно
5. Проверит, что настоящий тачпад остался активным

После выполнения проверьте, что фикс сработал:

```bash
cat /sys/devices/pci0000:00/0000:00:15.0/i2c_designware.0/i2c-0/i2c-GXTP7863:00/0018:27C6:01E0.0002/input/input16/inhibited
# Ожидаемый вывод: 1
```

Примечание: Путь может отличаться на вашей системе. Скрипт покажет вам правильный путь.

После перезагрузки правило применится автоматически, и проблема с яркостью должна исчезнуть.

### Способ 2: Ручная установка

Если вы предпочитаете настроить всё вручную:

#### 1. Создать файл правила

```bash
sudo nano /etc/udev/rules.d/99-block-gxtp7863-ghost.rules
```

Содержимое файла:

```
ACTION=="add", \
  ATTRS{id/bustype}=="0018", \
  ATTRS{id/vendor}=="27c6", \
  ATTRS{id/product}=="01e0", \
  ATTRS{id/version}=="0100", \
  ATTRS{properties}=="0", \
  ATTR{inhibited}="1"
```

Примечание: Значения `vendor`, `product`, `version` и `bustype` могут отличаться на другом ноутбуке. Берите их из вывода `cat /proc/bus/input/devices` для вашего фантомного устройства. Ключевой различающий признак - `ATTRS{properties}=="0"`.

#### 2. Проверить синтаксис правила

Возьмите путь `Sysfs=` фантомного устройства из вывода `cat /proc/bus/input/devices` и подставьте его:

```bash
sudo udevadm test /sys/devices/pci0000:00/0000:00:15.0/i2c_designware.0/i2c-0/i2c-GXTP7863:00/0018:27C6:01E0.0002/input/input16 2>&1 | grep -E "inhibit|Running|ATTR"
```

В выводе должна появиться строка с `ATTR{inhibited}` и либо `set to '1'`, либо `skipping writing` (в тестовом режиме). Если такой строки нет - проверьте значения в правиле.

#### 3. Применить правило

```bash
sudo udevadm control --reload-rules
sudo udevadm trigger --action=add --subsystem-match=input --attr-match=name="*GXTP7863*UNKNOWN*"
```

Альтернативно, можно указать конкретный путь устройства:

```bash
sudo udevadm trigger --action=add /sys/devices/pci0000:00/0000:00:15.0/i2c_designware.0/i2c-0/i2c-GXTP7863:00/0018:27C6:01E0.0002/input/input16
```

Примечание: Путь после `--action=add` должен начинаться с `/sys/` и соответствовать пути `Sysfs=` фантомного устройства (с добавленным префиксом `/sys/`).

#### 4. Проверить результат

Фантомное устройство должно быть заблокировано:

```bash
cat /sys/devices/pci0000:00/0000:00:15.0/i2c_designware.0/i2c-0/i2c-GXTP7863:00/0018:27C6:01E0.0002/input/input16/inhibited
# Ожидаемый вывод: 1
```

Настоящий тачпад должен остаться рабочим:

```bash
cat /sys/devices/pci0000:00/0000:00:15.0/i2c_designware.0/i2c-0/i2c-GXTP7863:00/0018:27C6:01E0.0002/input/input15/inhibited
# Ожидаемый вывод: 0
```

#### 5. Перезагрузить ноутбук

После перезагрузки правило применится автоматически. Проблема с яркостью должна исчезнуть.

## Решение проблем

- Если `inhibited` не появляется - проверьте путь к файлу: `find /sys/devices/pci0000:00/0000:00:15.0/ -name "inhibited"`. Файл может находиться на другом уровне иерархии.
- Если `udevadm trigger` без явного пути не применяет правило - укажите полный путь с `/sys/` и добавьте `--action=add`.
- Если номера `input` (input14, input15, input16) отличаются - ориентируйтесь по `Name` и `PROP` из вывода `cat /proc/bus/input/devices`, а не по номерам.
- Помните, что путь `Sysfs=` в `/proc/bus/input/devices` является относительным и требует префикса `/sys/` при использовании в командах.

## Удаление фикса

Чтобы удалить фикс:

```bash
sudo rm /etc/udev/rules.d/99-block-gxtp7863-ghost.rules
sudo udevadm control --reload-rules
sudo reboot
```
